name: Weekly Data Update

on:
  schedule:
    # 毎週日曜日 03:00 JST (土曜日 18:00 UTC)
    - cron: '0 18 * * 6'
  workflow_dispatch:
    # 手動実行も可能

# 並列実行を防止（SQLiteコンフリクト回避）
concurrency:
  group: weekly-update
  cancel-in-progress: false

env:
  REINFOLIB_API_KEY: ${{ secrets.REINFOLIB_API_KEY }}
  DB_RELEASE_TAG: db-latest

jobs:
  update-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create .env file
        run: |
          echo "REINFOLIB_API_KEY=${{ secrets.REINFOLIB_API_KEY }}" > .env

      - name: Download latest DB from release
        id: download_db
        run: |
          # 最新のDBリリースをダウンロード
          if gh release view ${{ env.DB_RELEASE_TAG }} &>/dev/null; then
            echo "Downloading DB from release..."
            gh release download ${{ env.DB_RELEASE_TAG }} -p "apartment.db" -D data/ --clobber
            echo "downloaded=true" >> $GITHUB_OUTPUT
          else
            echo "No existing DB release found, using repo version"
            echo "downloaded=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run SUUMO Scraper
        run: |
          echo "=== SUUMO Scraping Started at $(date) ==="
          cd scripts && python scrape_suumo.py
          echo "=== SUUMO Scraping Completed at $(date) ==="

      - name: Fetch Transaction Data from REINFOLIB
        run: |
          echo "=== REINFOLIB Fetch Started at $(date) ==="
          cd scripts && python fetch_reinfolib.py
          echo "=== REINFOLIB Fetch Completed at $(date) ==="

      - name: Calculate Market Prices
        run: |
          echo "=== Market Price Calculation Started at $(date) ==="
          cd scripts && python calc_market_price.py
          echo "=== Market Price Calculation Completed at $(date) ==="

      - name: Calculate Deal Scores
        run: |
          echo "=== Deal Score Calculation Started at $(date) ==="
          cd scripts && python calc_deal_score.py
          echo "=== Deal Score Calculation Completed at $(date) ==="

      - name: Run Geocoding
        run: |
          echo "=== Geocoding Started at $(date) ==="
          cd scripts && python geocode.py
          echo "=== Geocoding Completed at $(date) ==="

      - name: Upload DB to release
        run: |
          # リリースが存在しない場合は作成
          if ! gh release view ${{ env.DB_RELEASE_TAG }} &>/dev/null; then
            echo "Creating release ${{ env.DB_RELEASE_TAG }}..."
            gh release create ${{ env.DB_RELEASE_TAG }} \
              --title "Database (auto-updated)" \
              --notes "自動更新されるデータベースファイル" \
              --latest=false
          fi

          # DBファイルをアップロード（上書き）
          echo "Uploading apartment.db..."
          gh release upload ${{ env.DB_RELEASE_TAG }} data/apartment.db --clobber
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit and push changes to repo
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # DBファイルに変更があるか確認
          if ! git diff --quiet data/apartment.db; then
            git add data/apartment.db
            git commit -m "chore: weekly data update $(date +'%Y-%m-%d')"
            # リモートの変更を取り込んでからpush
            git pull --rebase origin main || true
            git push origin main || echo "Push failed, but DB is saved in release"
          else
            echo "No changes to commit"
          fi

      - name: Generate Summary
        run: |
          # DB統計を取得
          LISTINGS_COUNT=$(sqlite3 data/apartment.db "SELECT COUNT(*) FROM listings WHERE status='active'")
          NEW_COUNT=$(sqlite3 data/apartment.db "SELECT COUNT(*) FROM listings WHERE status='active' AND first_seen_at >= datetime('now', '-7 days')")
          PRICE_CHANGED=$(sqlite3 data/apartment.db "SELECT COUNT(*) FROM listings WHERE status='active' AND price_changed_at >= datetime('now', '-7 days')")
          SOLD_COUNT=$(sqlite3 data/apartment.db "SELECT COUNT(*) FROM listings WHERE status='sold'")
          HISTORY_COUNT=$(sqlite3 data/apartment.db "SELECT COUNT(*) FROM price_history")

          echo "## Weekly Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 実行情報" >> $GITHUB_STEP_SUMMARY
          echo "- **Date**: $(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Database size**: $(ls -lh data/apartment.db | awk '{print $5}')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 物件統計" >> $GITHUB_STEP_SUMMARY
          echo "| 項目 | 件数 |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| アクティブ物件 | ${LISTINGS_COUNT} |" >> $GITHUB_STEP_SUMMARY
          echo "| 新着（7日以内） | ${NEW_COUNT} |" >> $GITHUB_STEP_SUMMARY
          echo "| 価格変動（7日以内） | ${PRICE_CHANGED} |" >> $GITHUB_STEP_SUMMARY
          echo "| 掲載終了 | ${SOLD_COUNT} |" >> $GITHUB_STEP_SUMMARY
          echo "| 価格履歴レコード | ${HISTORY_COUNT} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Database uploaded to release: \`${{ env.DB_RELEASE_TAG }}\`" >> $GITHUB_STEP_SUMMARY
